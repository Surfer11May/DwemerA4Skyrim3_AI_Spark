services:
  # Permission fix for LLM cache, Milvus data, and Redis state
  init-chmod:
    image: busybox
    command: chmod -R 777 /opt/nim/.cache /var/lib/milvus /data
    volumes:
      - nim-cache:/opt/nim/.cache
      - milvus-data:/var/lib/milvus
      - redis-data:/data

  llm-main-32b:
    image: nvcr.io/nim/qwen/qwen3-32b-dgx-spark:1.1.0-variant
    profiles: ["Skyrim-Full-Stack"]
    runtime: nvidia
    shm_size: '16gb'
    ulimits:
      memlock: -1
      stack: 67108864
    depends_on: 
      init-chmod: { condition: service_completed_successfully }
    ports:
      - "8000:8000"
    environment:
      - NGC_API_KEY=${NGC_API_KEY}
      - NIM_GPU_MEM_FRACTION=0.6
      - NIM_MAX_MODEL_LEN=4096
    volumes:
      - nim-cache:/opt/nim/.cache
    deploy:
      resources:
        reservations:
          devices: [{driver: nvidia, device_ids: ['0'], capabilities: [gpu]}]

  # Milvus: The "Long-term Memory" for your Skyrim NPCs
  milvus:
    image: "milvusdb/milvus:v2.4.6"
    profiles: ["Skyrim-Full-Stack"]
    depends_on: [init-chmod]
    ports: ["19530:19530"]
    environment:
      - ETCD_USE_EMBED=true
      - COMMON_STORAGETYPE=local
    volumes: ["milvus-data:/var/lib/milvus"]
    command: "milvus run standalone"

  # Redis: Manages real-time AI Agent state and NPC task queues
  redis:
    image: "redis:7"
    profiles: ["Skyrim-Full-Stack"]
    depends_on: [init-chmod]
    ports: ["6379:6379"]
    volumes: ["redis-data:/data"]

volumes:
  nim-cache:
  milvus-data:
  redis-data:
